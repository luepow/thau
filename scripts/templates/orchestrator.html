<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THAU Development Orchestrator - Nova</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }

        .container {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            height: 100vh;
        }

        /* Sidebar - Agentes */
        .sidebar {
            background: rgba(0,0,0,0.4);
            padding: 20px;
            border-right: 1px solid rgba(255,255,255,0.1);
            overflow-y: auto;
        }

        .logo {
            text-align: center;
            padding: 15px 0;
            margin-bottom: 15px;
        }

        .logo img {
            width: 80px;
            height: auto;
            filter: drop-shadow(0 0 15px rgba(102, 126, 234, 0.6));
            transition: transform 0.3s, filter 0.3s;
        }

        .logo img:hover {
            transform: scale(1.05);
            filter: drop-shadow(0 0 20px rgba(102, 126, 234, 0.8));
        }

        /* Mode Tabs */
        .mode-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            padding: 5px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
        }

        .mode-tab {
            flex: 1;
            padding: 12px 10px;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: #888;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .mode-tab:hover {
            background: rgba(255,255,255,0.05);
            color: #aaa;
        }

        .mode-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .mode-tab-icon {
            font-size: 1.3rem;
        }

        .mode-tab-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .agent-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .agent-card:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }

        .agent-card.active {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.2);
        }

        .agent-card.working {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(102, 126, 234, 0); }
        }

        .agent-emoji { font-size: 28px; }
        .agent-info { flex: 1; }
        .agent-name { font-weight: bold; display: block; }
        .agent-title { font-size: 0.8rem; opacity: 0.7; }
        .agent-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #444;
        }
        .agent-status.online { background: #4ade80; }
        .agent-status.working { background: #fbbf24; animation: blink 0.5s infinite; }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Main Chat Area */
        .main {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: rgba(0,0,0,0.4);
            padding: 15px 25px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h2 {
            font-size: 1.3rem;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
        }

        .status-dot.connected { background: #4ade80; }

        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            display: flex;
            justify-content: flex-end;
        }

        .message.user .bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            max-width: 70%;
        }

        .message.agent .agent-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .bubble {
            background: rgba(255,255,255,0.1);
            padding: 15px 20px;
            border-radius: 18px;
            max-width: 85%;
            line-height: 1.6;
        }

        .bubble pre {
            background: rgba(0,0,0,0.4);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
            font-size: 0.85rem;
        }

        .bubble code {
            font-family: 'Fira Code', 'Monaco', monospace;
        }

        /* Input Area */
        .input-area {
            background: rgba(0,0,0,0.4);
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .project-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .project-input {
            flex: 1;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 10px 15px;
            color: #fff;
            font-size: 0.95rem;
        }

        .project-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .develop-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 10px 25px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .develop-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .develop-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .input-row {
            display: flex;
            gap: 10px;
        }

        #messageInput {
            flex: 1;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 25px;
            padding: 15px 25px;
            color: #fff;
            font-size: 1rem;
        }

        #messageInput:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 15px 30px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .send-btn:hover {
            transform: scale(1.02);
        }

        /* Voice Controls */
        .voice-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .voice-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 1.3rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mic-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .mic-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4);
        }

        .mic-btn.listening {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            animation: pulse-mic 1s infinite;
        }

        @keyframes pulse-mic {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
        }

        .speaker-btn {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .speaker-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .speaker-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }

        .speaker-btn.speaking {
            animation: pulse-speak 0.5s infinite;
        }

        @keyframes pulse-speak {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .voice-status {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.6);
            text-align: center;
            margin-top: 5px;
        }

        .voice-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: rgba(239, 68, 68, 0.2);
            border-radius: 20px;
            font-size: 0.8rem;
            color: #ef4444;
        }

        .voice-indicator.hidden {
            display: none;
        }

        .voice-wave {
            display: flex;
            gap: 2px;
            align-items: center;
        }

        .voice-wave span {
            width: 3px;
            background: #ef4444;
            border-radius: 2px;
            animation: wave 0.5s ease-in-out infinite;
        }

        .voice-wave span:nth-child(1) { height: 8px; animation-delay: 0s; }
        .voice-wave span:nth-child(2) { height: 12px; animation-delay: 0.1s; }
        .voice-wave span:nth-child(3) { height: 16px; animation-delay: 0.2s; }
        .voice-wave span:nth-child(4) { height: 12px; animation-delay: 0.3s; }
        .voice-wave span:nth-child(5) { height: 8px; animation-delay: 0.4s; }

        @keyframes wave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.5); }
        }

        /* Project Panel */
        .project-panel {
            background: rgba(0,0,0,0.4);
            padding: 20px;
            border-left: 1px solid rgba(255,255,255,0.1);
            overflow-y: auto;
        }

        .panel-section {
            margin-bottom: 25px;
        }

        .panel-section h3 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .project-status {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .status-value {
            opacity: 0.7;
        }

        .action-btn {
            width: 100%;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 12px;
            color: #fff;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }

        .action-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: none;
        }

        .action-btn.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: none;
        }

        .file-list {
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .file-item {
            background: rgba(255,255,255,0.05);
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 5px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .file-icon {
            opacity: 0.7;
        }

        /* Preview iframe */
        .preview-container {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            overflow: hidden;
            height: 200px;
        }

        .preview-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .preview-placeholder {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.5;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Login Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 40px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .modal-content h2 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.8rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .form-group input {
            width: 100%;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 12px 15px;
            color: #fff;
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .modal-btn.secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
        }

        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            opacity: 0.7;
        }

        .auth-toggle a {
            color: #667eea;
            cursor: pointer;
        }

        .error-msg {
            color: #ef4444;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* User bar */
        .user-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 25px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .user-name {
            font-size: 0.9rem;
        }

        .logout-btn {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            font-size: 0.85rem;
        }

        /* Project list panel */
        .project-list-panel {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .project-list {
            list-style: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .project-list-item {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .project-list-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .project-list-item.active {
            border: 2px solid #667eea;
            background: rgba(102, 126, 234, 0.2);
        }

        .project-list-item .project-info {
            flex: 1;
        }

        .project-list-item .project-name {
            font-weight: bold;
            display: block;
        }

        .project-list-item .project-meta {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .project-actions {
            display: flex;
            gap: 5px;
        }

        .project-action-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 5px;
            padding: 5px 8px;
            color: #fff;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .project-action-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .project-action-btn.delete {
            color: #ef4444;
        }

        .new-project-btn {
            width: 100%;
            background: rgba(102, 126, 234, 0.3);
            border: 2px dashed rgba(102, 126, 234, 0.5);
            border-radius: 10px;
            padding: 12px;
            color: #667eea;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .new-project-btn:hover {
            background: rgba(102, 126, 234, 0.5);
            border-color: #667eea;
        }

        /* Chat Capabilities */
        .chat-capabilities {
            margin-bottom: 20px;
        }

        .capability-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .capability-item:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.3);
            transform: translateX(5px);
        }

        .capability-icon {
            font-size: 1.3rem;
        }

        .capability-text {
            font-size: 0.9rem;
            color: #e0e0e0;
        }

        /* Chat Mode Header */
        .chat-header-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-header-title .mode-icon {
            font-size: 1.5rem;
        }

        /* Hide/Show content based on mode */
        .hidden-mode {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal-content">
            <h2>THAU Dev Studio</h2>
            <div id="authForm">
                <div class="form-group">
                    <label>Usuario</label>
                    <input type="text" id="authUsername" placeholder="tu_usuario" />
                </div>
                <div class="form-group">
                    <label>Contrasena</label>
                    <input type="password" id="authPassword" placeholder="********" />
                </div>
                <div id="authError" class="error-msg" style="display:none"></div>
                <div class="modal-buttons">
                    <button class="modal-btn primary" id="authSubmit" onclick="submitAuth()">Iniciar Sesion</button>
                    <button class="modal-btn secondary" onclick="skipLogin()">Continuar sin cuenta</button>
                </div>
                <div class="auth-toggle">
                    <span id="authToggleText">No tienes cuenta? </span>
                    <a onclick="toggleAuthMode()"><span id="authToggleLink">Registrate</span></a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Sidebar - Agentes -->
        <div class="sidebar">
            <div class="logo">
                <img src="/assets/logo.svg" alt="THAU" title="THAU - Cognitive Learning, Human Inspired">
            </div>

            <!-- Mode Tabs -->
            <div class="mode-tabs">
                <button class="mode-tab active" id="chatModeTab" onclick="switchMode('chat')">
                    <span class="mode-tab-icon">üí¨</span>
                    <span class="mode-tab-label">Chat</span>
                </button>
                <button class="mode-tab" id="devModeTab" onclick="switchMode('dev')">
                    <span class="mode-tab-icon">üöÄ</span>
                    <span class="mode-tab-label">Dev Studio</span>
                </button>
            </div>

            <!-- Chat Mode Content -->
            <div id="chatModeContent">
                <div class="chat-capabilities">
                    <h4 style="font-size: 0.8rem; opacity: 0.6; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">Capacidades</h4>
                    <div class="capability-item" onclick="setCapabilityPrompt('code')">
                        <span class="capability-icon">üíª</span>
                        <span class="capability-text">Generar Codigo</span>
                    </div>
                    <div class="capability-item" onclick="setCapabilityPrompt('svg')">
                        <span class="capability-icon">üé®</span>
                        <span class="capability-text">Crear SVG/Assets</span>
                    </div>
                    <div class="capability-item" onclick="setCapabilityPrompt('reason')">
                        <span class="capability-icon">üß†</span>
                        <span class="capability-text">Razonamiento</span>
                    </div>
                    <div class="capability-item" onclick="setCapabilityPrompt('accounting')">
                        <span class="capability-icon">üìä</span>
                        <span class="capability-text">Contabilidad</span>
                    </div>
                    <div class="capability-item" onclick="setCapabilityPrompt('devops')">
                        <span class="capability-icon">‚öôÔ∏è</span>
                        <span class="capability-text">DevOps/CI-CD</span>
                    </div>
                    <div class="capability-item" onclick="setCapabilityPrompt('explain')">
                        <span class="capability-icon">üìö</span>
                        <span class="capability-text">Explicar Codigo</span>
                    </div>
                </div>
            </div>

            <!-- Dev Studio Mode Content -->
            <div id="devModeContent" style="display: none;">
                <!-- Project List -->
                <div class="project-list-panel" id="projectListPanel">
                <h3 style="margin-bottom: 10px; font-size: 0.9rem; opacity: 0.7;">Mis Proyectos</h3>
                <ul class="project-list" id="projectList">
                    <li class="project-list-item" style="opacity:0.5">
                        Cargando proyectos...
                    </li>
                </ul>
                <button class="new-project-btn" onclick="showNewProjectDialog()">
                    + Nuevo Proyecto
                </button>
            </div>

            <div id="agentsList"></div>
            </div><!-- End devModeContent -->
        </div>

        <!-- Main Area -->
        <div class="main">
            <div class="header">
                <div class="chat-header-title" id="headerTitle">
                    <span class="mode-icon" id="headerIcon">üí¨</span>
                    <h2 id="headerText">Chat THAU</h2>
                </div>
                <div style="display:flex; align-items: center; gap: 15px;">
                    <div class="connection-status">
                        <span class="status-dot" id="connectionDot"></span>
                        <span id="connectionText">Desconectado</span>
                    </div>
                    <div class="user-bar" id="userBar" style="display:none">
                        <div class="user-avatar" id="userAvatar">?</div>
                        <span class="user-name" id="userName">Usuario</span>
                        <button class="logout-btn" onclick="logout()">Salir</button>
                    </div>
                </div>
            </div>

            <div class="chat-area" id="chatArea">
                <div class="message agent">
                    <div class="agent-header">
                        <span>ü§ñ</span>
                        <strong>THAU</strong>
                    </div>
                    <div class="bubble">
                        ¬°Hola! Soy THAU, tu asistente de inteligencia artificial.
                        <br><br>
                        Puedo ayudarte con:
                        <br><br>
                        ‚Ä¢ üíª <strong>Generar codigo</strong> en Python, JavaScript, Java, y mas<br>
                        ‚Ä¢ üé® <strong>Crear SVGs</strong> y assets visuales<br>
                        ‚Ä¢ üß† <strong>Razonamiento</strong> paso a paso (Chain of Thought)<br>
                        ‚Ä¢ üìä <strong>Contabilidad</strong> y asientos contables<br>
                        ‚Ä¢ ‚öôÔ∏è <strong>DevOps</strong> y configuracion CI/CD<br>
                        ‚Ä¢ üìö <strong>Explicar codigo</strong> y conceptos
                        <br><br>
                        <em>Selecciona una capacidad del menu o escribe tu pregunta directamente.</em>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <div class="project-row hidden-mode" id="projectRow">
                    <input type="text" class="project-input" id="projectName" placeholder="Nombre del proyecto" value="mi_proyecto" />
                    <button class="develop-btn" id="developBtn" onclick="startDevelopment()">
                        üöÄ Desarrollar Proyecto Completo
                    </button>
                </div>
                <div class="input-row">
                    <input type="text" id="messageInput" placeholder="Pregunta algo a THAU..." />
                    <div class="voice-controls">
                        <button class="voice-btn mic-btn" id="micBtn" onclick="toggleVoiceInput()" title="Hablar con THAU">
                            üé§
                        </button>
                        <button class="voice-btn speaker-btn" id="speakerBtn" onclick="toggleVoiceOutput()" title="Activar/Desactivar voz de THAU">
                            üîä
                        </button>
                    </div>
                    <button class="send-btn" onclick="sendMessage()">Enviar</button>
                </div>
                <div class="voice-indicator hidden" id="voiceIndicator">
                    <div class="voice-wave">
                        <span></span><span></span><span></span><span></span><span></span>
                    </div>
                    <span id="voiceStatus">Escuchando...</span>
                </div>
            </div>
        </div>

        <!-- Project Panel -->
        <div class="project-panel">
            <div class="panel-section">
                <h3>üìä Estado del Proyecto</h3>
                <div class="project-status">
                    <div class="status-item">
                        <span>Estado:</span>
                        <span class="status-value" id="projectStatus">Sin proyecto</span>
                    </div>
                    <div class="status-item">
                        <span>Archivos:</span>
                        <span class="status-value" id="fileCount">0</span>
                    </div>
                    <div class="status-item">
                        <span>Puerto:</span>
                        <span class="status-value" id="projectPort">-</span>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <h3>‚ö° Acciones</h3>
                <button class="action-btn primary" onclick="runProject()" id="runBtn">
                    ‚ñ∂Ô∏è Ejecutar Proyecto
                </button>
                <button class="action-btn danger" onclick="stopProject()" id="stopBtn" style="display:none">
                    ‚èπÔ∏è Detener
                </button>
                <button class="action-btn" onclick="openInBrowser()">
                    üåê Abrir en Navegador
                </button>
                <button class="action-btn" onclick="openFolder()">
                    üìÅ Abrir Carpeta
                </button>
                <button class="action-btn" onclick="downloadZip()" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); border: none;">
                    üì¶ Descargar ZIP
                </button>
            </div>

            <div class="panel-section">
                <h3>üñºÔ∏è Preview</h3>
                <div class="preview-container" id="previewContainer">
                    <div class="preview-placeholder">
                        <span>Ejecuta el proyecto para ver el preview</span>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <h3>üìÑ Archivos Creados</h3>
                <ul class="file-list" id="fileList">
                    <li class="file-item" style="opacity:0.5">
                        <span class="file-icon">üìÑ</span>
                        Sin archivos a√∫n...
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n
        const AGENTS = {
            nova: { name: 'Nova', title: 'Project Orchestrator', emoji: 'üåü' },
            atlas: { name: 'Atlas', title: 'System Architect', emoji: 'üèõÔ∏è' },
            pixel: { name: 'Pixel', title: 'Frontend Wizard', emoji: 'üé®' },
            forge: { name: 'Forge', title: 'Backend Architect', emoji: 'üîß' },
            aura: { name: 'Aura', title: 'Experience Designer', emoji: 'üí´' },
            sentinel: { name: 'Sentinel', title: 'Quality Guardian', emoji: 'üõ°Ô∏è' },
            rocket: { name: 'Rocket', title: 'Launch Engineer', emoji: 'üöÄ' }
        };

        let ws = null;
        let isConnected = false;
        let currentProject = null;
        let selectedAgent = 'nova';
        let authToken = localStorage.getItem('thau_token');
        let currentUser = localStorage.getItem('thau_user');
        let isRegisterMode = false;
        let projectsList = [];
        let currentMode = 'chat'; // 'chat' or 'dev'

        // Capability prompts for Chat Mode
        const CAPABILITY_PROMPTS = {
            code: 'Genera codigo para ',
            svg: 'Crea un SVG de ',
            reason: 'Analiza paso a paso: ',
            accounting: 'Registra el asiento contable para ',
            devops: 'Configura el pipeline CI/CD para ',
            explain: 'Explica el siguiente codigo: '
        };

        // Mode switching function
        function switchMode(mode) {
            currentMode = mode;

            // Update tabs
            document.getElementById('chatModeTab').classList.toggle('active', mode === 'chat');
            document.getElementById('devModeTab').classList.toggle('active', mode === 'dev');

            // Update sidebar content
            document.getElementById('chatModeContent').style.display = mode === 'chat' ? 'block' : 'none';
            document.getElementById('devModeContent').style.display = mode === 'dev' ? 'block' : 'none';

            // Update header
            if (mode === 'chat') {
                document.getElementById('headerIcon').textContent = 'üí¨';
                document.getElementById('headerText').textContent = 'Chat THAU';
            } else {
                document.getElementById('headerIcon').textContent = 'üöÄ';
                document.getElementById('headerText').textContent = 'Dev Studio - Nova';
            }

            // Update input area
            document.getElementById('projectRow').classList.toggle('hidden-mode', mode === 'chat');

            // Update placeholder
            const input = document.getElementById('messageInput');
            if (mode === 'chat') {
                input.placeholder = 'Pregunta algo a THAU...';
            } else {
                input.placeholder = 'Describe tu proyecto o haz una pregunta a un agente...';
            }

            // Clear chat area and show welcome message
            showWelcomeMessage(mode);
        }

        function showWelcomeMessage(mode) {
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = '';

            if (mode === 'chat') {
                chatArea.innerHTML = `
                    <div class="message agent">
                        <div class="agent-header">
                            <span>ü§ñ</span>
                            <strong>THAU</strong>
                        </div>
                        <div class="bubble">
                            ¬°Hola! Soy THAU, tu asistente de inteligencia artificial.
                            <br><br>
                            Puedo ayudarte con:
                            <br><br>
                            ‚Ä¢ üíª <strong>Generar codigo</strong> en Python, JavaScript, Java, y mas<br>
                            ‚Ä¢ üé® <strong>Crear SVGs</strong> y assets visuales<br>
                            ‚Ä¢ üß† <strong>Razonamiento</strong> paso a paso (Chain of Thought)<br>
                            ‚Ä¢ üìä <strong>Contabilidad</strong> y asientos contables<br>
                            ‚Ä¢ ‚öôÔ∏è <strong>DevOps</strong> y configuracion CI/CD<br>
                            ‚Ä¢ üìö <strong>Explicar codigo</strong> y conceptos
                            <br><br>
                            <em>Selecciona una capacidad del menu o escribe tu pregunta directamente.</em>
                        </div>
                    </div>
                `;
            } else {
                chatArea.innerHTML = `
                    <div class="message agent">
                        <div class="agent-header">
                            <span>üåü</span>
                            <strong>Nova</strong>
                        </div>
                        <div class="bubble">
                            ¬°Hola! Soy Nova, tu Project Orchestrator.
                            <br><br>
                            Describe el proyecto que quieres crear y yo coordinare automaticamente a todo el equipo THAU para desarrollarlo completo:
                            <br><br>
                            ‚Ä¢ üèõÔ∏è <strong>Atlas</strong> disenara la arquitectura<br>
                            ‚Ä¢ üé® <strong>Pixel</strong> creara el frontend<br>
                            ‚Ä¢ üîß <strong>Forge</strong> desarrollara el backend<br>
                            ‚Ä¢ üí´ <strong>Aura</strong> mejorara la UX<br>
                            ‚Ä¢ üõ°Ô∏è <strong>Sentinel</strong> creara tests<br>
                            ‚Ä¢ üöÄ <strong>Rocket</strong> configurara la ejecucion
                            <br><br>
                            <em>Ejemplo: "Crea una landing page para una startup de tecnologia con seccion hero, caracteristicas, testimonios y formulario de contacto"</em>
                        </div>
                    </div>
                `;
            }
        }

        function setCapabilityPrompt(type) {
            const prompt = CAPABILITY_PROMPTS[type] || '';
            document.getElementById('messageInput').value = prompt;
            document.getElementById('messageInput').focus();
        }

        // ============================================
        // VOICE RECOGNITION & SYNTHESIS
        // ============================================

        let recognition = null;
        let synthesis = window.speechSynthesis;
        let isListening = false;
        let voiceOutputEnabled = true;
        let currentUtterance = null;
        let spanishVoice = null;

        // Initialize Speech Recognition
        function initVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'es-ES';

                recognition.onstart = function() {
                    isListening = true;
                    document.getElementById('micBtn').classList.add('listening');
                    document.getElementById('voiceIndicator').classList.remove('hidden');
                    document.getElementById('voiceStatus').textContent = 'Escuchando...';
                };

                recognition.onresult = function(event) {
                    let finalTranscript = '';
                    let interimTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }

                    // Show interim results in input
                    if (interimTranscript) {
                        document.getElementById('messageInput').value = interimTranscript;
                        document.getElementById('voiceStatus').textContent = 'Escuchando: ' + interimTranscript.substring(0, 30) + '...';
                    }

                    // Send final result
                    if (finalTranscript) {
                        document.getElementById('messageInput').value = finalTranscript;
                        document.getElementById('voiceStatus').textContent = 'Procesando...';
                        // Auto send after recognition
                        setTimeout(() => {
                            sendMessage();
                        }, 500);
                    }
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    stopListening();
                    if (event.error === 'not-allowed') {
                        alert('Por favor permite el acceso al microfono para usar la funcion de voz.');
                    }
                };

                recognition.onend = function() {
                    stopListening();
                };

                console.log('Voice recognition initialized');
            } else {
                console.warn('Speech recognition not supported');
                document.getElementById('micBtn').style.display = 'none';
            }
        }

        // Initialize Speech Synthesis voices
        function initVoiceSynthesis() {
            if ('speechSynthesis' in window) {
                // Load voices
                function loadVoices() {
                    const voices = synthesis.getVoices();
                    // Find Spanish voice
                    spanishVoice = voices.find(v => v.lang.startsWith('es')) ||
                                   voices.find(v => v.lang.includes('ES')) ||
                                   voices[0];
                    console.log('Voice loaded:', spanishVoice ? spanishVoice.name : 'default');
                }

                loadVoices();
                synthesis.onvoiceschanged = loadVoices;

                // Check saved preference
                const savedPref = localStorage.getItem('thau_voice_enabled');
                voiceOutputEnabled = savedPref !== 'false';
                updateSpeakerButton();

                console.log('Voice synthesis initialized');
            } else {
                console.warn('Speech synthesis not supported');
                document.getElementById('speakerBtn').style.display = 'none';
            }
        }

        function toggleVoiceInput() {
            if (!recognition) {
                alert('Tu navegador no soporta reconocimiento de voz. Usa Chrome o Edge.');
                return;
            }

            if (isListening) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (e) {
                    console.error('Error starting recognition:', e);
                }
            }
        }

        function stopListening() {
            isListening = false;
            document.getElementById('micBtn').classList.remove('listening');
            document.getElementById('voiceIndicator').classList.add('hidden');
        }

        function toggleVoiceOutput() {
            voiceOutputEnabled = !voiceOutputEnabled;
            localStorage.setItem('thau_voice_enabled', voiceOutputEnabled);
            updateSpeakerButton();

            // Stop current speech if disabling
            if (!voiceOutputEnabled && synthesis.speaking) {
                synthesis.cancel();
            }
        }

        function updateSpeakerButton() {
            const btn = document.getElementById('speakerBtn');
            if (voiceOutputEnabled) {
                btn.classList.add('active');
                btn.innerHTML = 'üîä';
                btn.title = 'Voz activada - Click para desactivar';
            } else {
                btn.classList.remove('active');
                btn.innerHTML = 'üîá';
                btn.title = 'Voz desactivada - Click para activar';
            }
        }

        // Audio player for TTS
        let currentAudio = null;
        let useNeuralVoice = true; // Use THAU's neural voice (backend TTS)

        async function speakText(text) {
            if (!voiceOutputEnabled) return;

            // Stop any ongoing speech
            stopSpeaking();

            // Clean text for speech (remove code blocks, markdown, etc.)
            let cleanText = text
                .replace(/```[\s\S]*?```/g, 'Codigo omitido.')
                .replace(/`[^`]+`/g, '')
                .replace(/\*\*([^*]+)\*\*/g, '$1')
                .replace(/\*([^*]+)\*/g, '$1')
                .replace(/#{1,6}\s/g, '')
                .replace(/<[^>]+>/g, '')
                .replace(/\n+/g, '. ')
                .replace(/\s+/g, ' ')
                .trim();

            // Limit length for speech
            if (cleanText.length > 500) {
                cleanText = cleanText.substring(0, 500) + '... Respuesta completa en pantalla.';
            }

            if (!cleanText) return;

            // Use THAU's neural voice (backend TTS) if available
            if (useNeuralVoice) {
                try {
                    document.getElementById('speakerBtn').classList.add('speaking');

                    const response = await fetch('/api/tts/synthesize', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: cleanText, voice: 'eddy_mx' })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.audio) {
                            // Determine audio MIME type based on format
                            const mimeType = data.format === 'aiff' ? 'audio/aiff' : 'audio/wav';
                            // Play the audio from base64
                            currentAudio = new Audio('data:' + mimeType + ';base64,' + data.audio);
                            currentAudio.onended = function() {
                                document.getElementById('speakerBtn').classList.remove('speaking');
                                currentAudio = null;
                            };
                            currentAudio.onerror = function(e) {
                                console.error('Audio playback error:', e);
                                document.getElementById('speakerBtn').classList.remove('speaking');
                                // Fallback to browser TTS
                                speakWithBrowserTTS(cleanText);
                            };
                            currentAudio.play();
                            return;
                        }
                    }
                    // Fallback to browser TTS if backend fails
                    speakWithBrowserTTS(cleanText);
                } catch (error) {
                    console.error('TTS API error:', error);
                    // Fallback to browser TTS
                    speakWithBrowserTTS(cleanText);
                }
            } else {
                speakWithBrowserTTS(cleanText);
            }
        }

        function speakWithBrowserTTS(cleanText) {
            if (!synthesis) return;

            document.getElementById('speakerBtn').classList.add('speaking');

            currentUtterance = new SpeechSynthesisUtterance(cleanText);
            currentUtterance.voice = spanishVoice;
            currentUtterance.lang = 'es-ES';
            currentUtterance.rate = 1.0;
            currentUtterance.pitch = 1.0;
            currentUtterance.volume = 1.0;

            currentUtterance.onend = function() {
                document.getElementById('speakerBtn').classList.remove('speaking');
            };

            currentUtterance.onerror = function(event) {
                console.error('Speech error:', event);
                document.getElementById('speakerBtn').classList.remove('speaking');
            };

            synthesis.speak(currentUtterance);
        }

        function stopSpeaking() {
            // Stop backend TTS audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio = null;
            }
            // Stop browser TTS
            if (synthesis && synthesis.speaking) {
                synthesis.cancel();
            }
            // Update UI
            const btn = document.getElementById('speakerBtn');
            if (btn) btn.classList.remove('speaking');
        }

        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================

        function checkAuth() {
            if (authToken && currentUser) {
                // Validate token
                fetch('/api/auth/validate/' + authToken)
                    .then(r => r.json())
                    .then(data => {
                        if (data.valid) {
                            hideLoginModal();
                            showUserBar(currentUser);
                            loadProjects();
                        } else {
                            clearAuth();
                            showLoginModal();
                        }
                    })
                    .catch(() => {
                        // Token invalid, show login
                        showLoginModal();
                    });
            } else {
                showLoginModal();
            }
        }

        function showLoginModal() {
            document.getElementById('loginModal').classList.remove('hidden');
        }

        function hideLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
        }

        function toggleAuthMode() {
            isRegisterMode = !isRegisterMode;
            const btn = document.getElementById('authSubmit');
            const toggleText = document.getElementById('authToggleText');
            const toggleLink = document.getElementById('authToggleLink');

            if (isRegisterMode) {
                btn.textContent = 'Registrarse';
                toggleText.textContent = 'Ya tienes cuenta? ';
                toggleLink.textContent = 'Inicia sesion';
            } else {
                btn.textContent = 'Iniciar Sesion';
                toggleText.textContent = 'No tienes cuenta? ';
                toggleLink.textContent = 'Registrate';
            }
        }

        async function submitAuth() {
            const username = document.getElementById('authUsername').value.trim();
            const password = document.getElementById('authPassword').value.trim();
            const errorEl = document.getElementById('authError');

            if (!username || !password) {
                errorEl.textContent = 'Por favor completa todos los campos';
                errorEl.style.display = 'block';
                return;
            }

            const endpoint = isRegisterMode ? '/api/auth/register' : '/api/auth/login';

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    if (isRegisterMode) {
                        // After register, login
                        isRegisterMode = false;
                        toggleAuthMode();
                        errorEl.textContent = '';
                        errorEl.style.display = 'none';
                        alert('Registro exitoso! Ahora inicia sesion.');
                    } else {
                        // Login success
                        authToken = data.token;
                        currentUser = data.username;
                        localStorage.setItem('thau_token', authToken);
                        localStorage.setItem('thau_user', currentUser);
                        hideLoginModal();
                        showUserBar(currentUser);
                        loadProjects();
                    }
                } else {
                    errorEl.textContent = data.detail || 'Error de autenticacion';
                    errorEl.style.display = 'block';
                }
            } catch (err) {
                errorEl.textContent = 'Error de conexion';
                errorEl.style.display = 'block';
            }
        }

        function skipLogin() {
            hideLoginModal();
            loadProjects();
        }

        function showUserBar(username) {
            const userBar = document.getElementById('userBar');
            const avatar = document.getElementById('userAvatar');
            const name = document.getElementById('userName');

            avatar.textContent = username.charAt(0).toUpperCase();
            name.textContent = username;
            userBar.style.display = 'flex';
        }

        function clearAuth() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('thau_token');
            localStorage.removeItem('thau_user');
        }

        function logout() {
            if (authToken) {
                fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: authToken })
                });
            }
            clearAuth();
            document.getElementById('userBar').style.display = 'none';
            showLoginModal();
        }

        // ============================================
        // PROJECT MANAGEMENT FUNCTIONS
        // ============================================

        async function loadProjects() {
            try {
                const response = await fetch('/api/projects/list');
                const data = await response.json();
                projectsList = data.projects || [];
                renderProjectList();
            } catch (err) {
                console.error('Error loading projects:', err);
            }
        }

        function renderProjectList() {
            const list = document.getElementById('projectList');

            if (projectsList.length === 0) {
                list.innerHTML = '<li class="project-list-item" style="opacity:0.5">No hay proyectos. Crea uno nuevo!</li>';
                return;
            }

            list.innerHTML = projectsList.map(p => `
                <li class="project-list-item ${currentProject === p.id ? 'active' : ''}" onclick="selectProject('${p.id}')">
                    <div class="project-info">
                        <span class="project-name">${p.name}</span>
                        <span class="project-meta">${p.type} - ${p.file_count} archivos</span>
                    </div>
                    <div class="project-actions">
                        <button class="project-action-btn" onclick="event.stopPropagation(); downloadProjectZip('${p.id}')" title="Descargar ZIP">üì¶</button>
                        <button class="project-action-btn delete" onclick="event.stopPropagation(); deleteProject('${p.id}')" title="Eliminar">üóëÔ∏è</button>
                    </div>
                </li>
            `).join('');
        }

        async function selectProject(projectId) {
            try {
                const response = await fetch('/api/projects/' + projectId + '/select', {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    currentProject = projectId;
                    document.getElementById('projectName').value = data.project.name;
                    updateProjectStatus(data.project);
                    updateFileList(data.files);
                    renderProjectList();
                }
            } catch (err) {
                console.error('Error selecting project:', err);
            }
        }

        function showNewProjectDialog() {
            const name = prompt('Nombre del nuevo proyecto:');
            if (name && name.trim()) {
                createNewProject(name.trim());
            }
        }

        async function createNewProject(name) {
            try {
                const response = await fetch('/api/projects/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        type: 'html',
                        token: authToken
                    })
                });
                const data = await response.json();

                if (data.success) {
                    currentProject = name.toLowerCase().replace(/[^a-z0-9_-]/g, '_');
                    document.getElementById('projectName').value = name;
                    loadProjects();
                }
            } catch (err) {
                alert('Error creando proyecto: ' + err.message);
            }
        }

        async function deleteProject(projectId) {
            if (!confirm('Eliminar proyecto "' + projectId + '"? Esta accion no se puede deshacer.')) {
                return;
            }

            try {
                const response = await fetch('/api/projects/' + projectId, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    if (currentProject === projectId) {
                        currentProject = null;
                    }
                    loadProjects();
                }
            } catch (err) {
                alert('Error eliminando proyecto: ' + err.message);
            }
        }

        function downloadProjectZip(projectId) {
            window.location.href = '/api/projects/' + projectId + '/download';
        }

        function downloadZip() {
            if (!currentProject) {
                alert('No hay proyecto seleccionado');
                return;
            }
            downloadProjectZip(currentProject);
        }

        // Inicializar agentes
        function initAgents() {
            const container = document.getElementById('agentsList');
            container.innerHTML = '';

            for (const [id, agent] of Object.entries(AGENTS)) {
                const div = document.createElement('div');
                div.className = 'agent-card' + (id === selectedAgent ? ' active' : '');
                div.id = 'agent-' + id;
                div.onclick = () => selectAgent(id);
                div.innerHTML = `
                    <span class="agent-emoji">${agent.emoji}</span>
                    <div class="agent-info">
                        <span class="agent-name">${agent.name}</span>
                        <span class="agent-title">${agent.title}</span>
                    </div>
                    <div class="agent-status" id="status-${id}"></div>
                `;
                container.appendChild(div);
            }
        }

        function selectAgent(id) {
            selectedAgent = id;
            document.querySelectorAll('.agent-card').forEach(card => {
                card.classList.remove('active');
            });
            document.getElementById('agent-' + id).classList.add('active');
        }

        function setAgentWorking(agentName, working) {
            const id = Object.keys(AGENTS).find(k => AGENTS[k].name === agentName);
            if (id) {
                const card = document.getElementById('agent-' + id);
                const status = document.getElementById('status-' + id);
                if (working) {
                    card.classList.add('working');
                    status.classList.add('working');
                } else {
                    card.classList.remove('working');
                    status.classList.remove('working');
                    status.classList.add('online');
                }
            }
        }

        function updateConnection(connected) {
            isConnected = connected;
            const dot = document.getElementById('connectionDot');
            const text = document.getElementById('connectionText');

            if (connected) {
                dot.classList.add('connected');
                text.textContent = 'Conectado';
            } else {
                dot.classList.remove('connected');
                text.textContent = 'Desconectado';
            }
        }

        function connectWebSocket() {
            ws = new WebSocket('ws://' + window.location.host + '/ws/develop');

            ws.onopen = function() {
                console.log('WebSocket conectado');
                updateConnection(true);
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('Mensaje:', data);

                // Actualizar agente trabajando
                if (data.agent) {
                    setAgentWorking(data.agent, false);
                }

                // A√±adir mensaje
                addMessage(data.agent, data.emoji, data.response, 'agent');

                // Actualizar archivos
                if (data.files && data.files.length > 0) {
                    updateFileList(data.files);
                }

                // Actualizar proyecto
                if (data.project) {
                    updateProjectStatus(data.project);
                }
            };

            ws.onclose = function() {
                console.log('WebSocket cerrado');
                updateConnection(false);
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateConnection(false);
            };
        }

        function addMessage(name, emoji, content, type) {
            const chatArea = document.getElementById('chatArea');
            const div = document.createElement('div');
            div.className = 'message ' + type;

            // Save original content for speech
            const originalContent = content;

            // Formatear c√≥digo
            content = content.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
            content = content.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            content = content.replace(/\n/g, '<br>');

            if (type === 'agent') {
                div.innerHTML = `
                    <div class="agent-header">
                        <span>${emoji || 'ü§ñ'}</span>
                        <strong>${name || 'Sistema'}</strong>
                        <button class="voice-btn speaker-btn" style="width:28px;height:28px;font-size:0.9rem;margin-left:auto;" onclick="speakText(\`${content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)" title="Escuchar respuesta">
                            üîä
                        </button>
                    </div>
                    <div class="bubble">${content}</div>
                `;
                // Auto-speak agent responses if enabled
                speakText(originalContent);
            } else {
                div.innerHTML = `<div class="bubble">${content}</div>`;
            }

            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function startDevelopment() {
            const projectName = document.getElementById('projectName').value.trim() || 'mi_proyecto';
            const requirements = document.getElementById('messageInput').value.trim();

            if (!requirements) {
                alert('Por favor, describe el proyecto que quieres crear');
                return;
            }

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('WebSocket no conectado. Reconectando...');
                connectWebSocket();
                return;
            }

            addMessage('T√∫', 'üë§', requirements, 'user');
            document.getElementById('messageInput').value = '';

            // Marcar todos los agentes como trabajando
            Object.keys(AGENTS).forEach(id => {
                document.getElementById('status-' + id).classList.add('online');
            });
            setAgentWorking('Nova', true);

            ws.send(JSON.stringify({
                action: 'develop',
                requirements: requirements,
                project: projectName
            }));

            currentProject = projectName;
        }

        function sendMessage() {
            const message = document.getElementById('messageInput').value.trim();
            if (!message) return;

            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('WebSocket no conectado');
                return;
            }

            addMessage('Tu', 'üë§', message, 'user');
            document.getElementById('messageInput').value = '';

            if (currentMode === 'chat') {
                // Chat mode - direct conversation with THAU
                ws.send(JSON.stringify({
                    action: 'chat',
                    agent: 'thau',
                    message: message,
                    mode: 'chat'
                }));
            } else {
                // Dev mode - agent conversation
                setAgentWorking(AGENTS[selectedAgent].name, true);
                ws.send(JSON.stringify({
                    action: 'chat',
                    agent: selectedAgent,
                    message: message,
                    project: currentProject || document.getElementById('projectName').value
                }));
            }
        }

        function updateFileList(files) {
            const list = document.getElementById('fileList');
            list.innerHTML = files.map(f => {
                const icon = getFileIcon(f);
                return `<li class="file-item" onclick="viewFile('${f}')">
                    <span class="file-icon">${icon}</span>
                    ${f}
                </li>`;
            }).join('');

            document.getElementById('fileCount').textContent = files.length;
        }

        function getFileIcon(filename) {
            if (filename.endsWith('.js') || filename.endsWith('.jsx')) return 'üìú';
            if (filename.endsWith('.ts') || filename.endsWith('.tsx')) return 'üìò';
            if (filename.endsWith('.css')) return 'üé®';
            if (filename.endsWith('.html')) return 'üåê';
            if (filename.endsWith('.json')) return 'üìã';
            if (filename.endsWith('.py')) return 'üêç';
            if (filename.endsWith('.md')) return 'üìù';
            return 'üìÑ';
        }

        function updateProjectStatus(project) {
            document.getElementById('projectStatus').textContent = project.status || 'Activo';
            document.getElementById('projectPort').textContent = project.port || '-';
            currentProject = project.name;

            if (project.status === 'running') {
                document.getElementById('runBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'block';

                // Mostrar preview
                const container = document.getElementById('previewContainer');
                container.innerHTML = `<iframe src="http://localhost:${project.port}" title="Preview"></iframe>`;
            } else {
                document.getElementById('runBtn').style.display = 'block';
                document.getElementById('stopBtn').style.display = 'none';
            }
        }

        function runProject() {
            if (!currentProject) {
                alert('No hay proyecto activo');
                return;
            }

            ws.send(JSON.stringify({
                action: 'run',
                project: currentProject
            }));
        }

        function stopProject() {
            if (!currentProject) return;

            ws.send(JSON.stringify({
                action: 'stop',
                project: currentProject
            }));
        }

        function openInBrowser() {
            const port = document.getElementById('projectPort').textContent;
            if (port && port !== '-') {
                window.open('http://localhost:' + port, '_blank');
            } else {
                alert('Proyecto no est√° corriendo');
            }
        }

        function openFolder() {
            // Esta funci√≥n solo funciona si hay integraci√≥n con el sistema
            alert('Abre la carpeta ~/thau_projects/' + (currentProject || 'mi_proyecto'));
        }

        function viewFile(filepath) {
            if (!currentProject) return;

            ws.send(JSON.stringify({
                action: 'read',
                project: currentProject,
                file: filepath
            }));
        }

        // Event listeners
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (e.shiftKey) {
                    startDevelopment();
                } else {
                    sendMessage();
                }
            }
        });

        // Inicializar
        initAgents();
        connectWebSocket();
        checkAuth();
        initVoiceRecognition();
        initVoiceSynthesis();
    </script>
</body>
</html>
